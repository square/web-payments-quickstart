<!DOCTYPE html>
<html>
  <head>
    <link href="app.css" rel="stylesheet" />
    <style>
      #apple-pay-button {
        height: 48px;
        width: 100%;
        display: inline-block;
        -webkit-appearance: -apple-pay-button;
        -apple-pay-button-type: plain;
        -apple-pay-button-style: black;
      }
    </style>
    <script
      type="text/javascript"
      src="https://sandbox.web.squarecdn.com/v0.1/square.js"
    ></script>
    <script>
      const appId = '{APPLICATION_ID}';
      const locationId = '{LOCATION_ID}';

      async function initializeCard(payments) {
        const card = await payments.card();
        await card.attach('#card-container');

        return card;
      }

      async function initializeApplePay(payments) {
        const paymentRequest = payments.paymentRequest({
          countryCode: 'US',
          currencyCode: 'USD',
          total: {
            amount: '1.00',
            label: 'Total',
          },
        });

        const applePay = await payments.applePay(paymentRequest);
        // Note: You do not need to `attach` applePay.
        return applePay;
      }

      async function createPayment(token) {
        const body = JSON.stringify({
          locationId,
          sourceId: token,
        });

        const paymentResponse = await fetch('/payment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body,
        });

        if (paymentResponse.ok) {
          return paymentResponse.json();
        }

        const errorBody = await paymentResponse.text();
        throw new Error(errorBody);
      }

      // Change the parameter to 'paymentMethod'
      async function tokenize(paymentMethod) {
        const tokenResult = await paymentMethod.tokenize();
        if (tokenResult.status === 'OK') {
          return tokenResult.token;
        } else {
          let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;
          if (tokenResult.errors) {
            errorMessage += ` and errors: ${JSON.stringify(
              tokenResult.errors
            )}`;
          }

          throw new Error(errorMessage);
        }
      }

      document.addEventListener('DOMContentLoaded', async function () {
        if (!window.Square) {
          throw new Error('Square.js failed to load properly');
        }

        const payments = window.Square.payments(appId, locationId);
        let card;
        try {
          card = await initializeCard(payments);
        } catch (e) {
          console.error('Initializing Card failed', e);
          return;
        }

        let applePay;
        try {
          applePay = await initializeApplePay(payments);
        } catch (e) {
          console.error('Initializing Apple Pay failed', e);
          // There are a number of reason why Apple Pay may not be supported
          // (e.g. Browser Support, Device Support, Account). Therefore you should handle
          // initialization failures, while still loading other applicable payment methods.
        }

        const cardSubmissionButton = document.getElementById(
          'card-submission-button'
        );
        async function handlePaymentMethodSubmission(event, paymentMethod) {
          event.preventDefault();

          try {
            // disable the submit button as we await tokenization and make a payment request.
            cardSubmissionButton.disabled = true;
            const token = await tokenize(paymentMethod);
            const paymentResults = await createPayment(token);

            console.debug('Payment Success', paymentResults);
          } catch (e) {
            cardSubmissionButton.disabled = false;
            console.error(e.message);
          }
        }

        cardSubmissionButton.addEventListener('click', async function (event) {
          await handlePaymentMethodSubmission(event, card);
        });

        // Checkpoint 2.
        const applePayButton = document.getElementById('apple-pay-button');
        applePayButton.addEventListener('click', async function (event) {
          await handlePaymentMethodSubmission(event, applePay);
        });
      });
    </script>
  </head>
  <body>
    <form id="payment-form">
      <div id="apple-pay-button"></div>
      <div id="card-container"></div>
      <button id="card-submission-button" type="submit">Pay $1.00</button>
    </form>
  </body>
</html>

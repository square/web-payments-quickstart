<!DOCTYPE html>
<html>
  <head>
    <link href="app.css" rel="stylesheet" />
    <script
      type="text/javascript"
      src="https://sandbox.web.squarecdn.com/0.0.29-canary.sha-8a9da52/square.js"
    ></script>
    <script type="module">
      // Checkpoint 1
      import {
        initializeGooglePay,
        createGooglePayPaymentOnClick,
      } from './payment-methods/google-pay.js';
      // Checkpoint 1
      const appId = 'sandbox-sq0idb-lybe_WkfKNAbb3WklswmwA';
      const locationId = 'LKYXSPGPXK05M';

      // Checkpoint 1
      async function initializePayments(appId, locationId) {
        const payments = window.Square.payments(appId, locationId);

        const defaultShippingOptions = [
          {
            amount: '0.00',
            id: 'shipping-option-1',
            label: 'Free',
          },
          {
            amount: '10.00',
            id: 'shipping-option-2',
            label: 'Expedited',
          },
        ];

        let lineItems = [
          { amount: '2.00', label: 'Item Cost', pending: false },
          { amount: '0.00', label: 'Shipping', pending: false },
          { amount: '0.50', label: 'Tax', pending: false },
        ];

        let total = {
          amount: '2.50',
          label: 'Total',
          pending: false,
        };

        const paymentRequestDetails = {
          countryCode: 'US',
          currencyCode: 'USD',
          lineItems,
          requestBillingContact: true,
          requestShippingContact: true,
          shippingOptions: defaultShippingOptions,
          total,
        };

        const paymentRequest = payments.paymentRequest(paymentRequestDetails);

        // Checkpoint 2
        paymentRequest.addEventListener('shippingcontactchanged', (contact, update) => {
          // Add your business logic here.
          // This tells you the address of the buyer, and allows you to update your shipping options
          // and pricing based on their location.
          const isCA = contact.state === 'CA';

          const newShippingOptions = isCA ? defaultShippingOptions : [
            {
              id: 'shipping-options-3',
              label: 'Standard Shipping',
              amount: '15.00',
            },
            {
              id: 'shipping-options-4',
              label: 'Express Shipping',
              amount: '25.00',
            },
          ];

          // update the shipping options as they change per location and go back to the first event
          let updatedShippingItem = false;
          let newLineItems = lineItems.map((lineItem) => {
            if (lineItem.label === 'Shipping') {
              updatedShippingItem = true;
              return Object.assign({}, lineItem, { amount: newShippingOptions[0].amount })
            }

            return lineItem;
          });

          if (!updatedShippingItem) {
            newLineItems.push({ label: 'Shipping', amount: newShippingOptions[0].amount, pending: false });
          }

          // Add up the amounts and convert to a string in the format of #.##, e.g. '2.23'
          const amount = newLineItems
            .reduce((total, lineItem) => {
              total += parseFloat(lineItem.amount);
              return total;
            }, 0.0)
            .toFixed(2);

          const newTotal = Object.assign({}, total, { amount });

          total = newTotal;
          lineItems = newLineItems;

          update({
            lineItems: newLineItems,
            shippingOptions: newShippingOptions,
            total: newTotal,
          });
        });

        // Checkpoint 3
        paymentRequest.addEventListener('shippingoptionchanged', (option, update) => {
          // Add your business logic here.
          // This tells you the shipping options selected by the buyer, and allows you to update
          // totals based on the pricing of each shipping option.
          let updatedShippingItem = false;
          let newLineItems = lineItems.map((lineItem) => {
            if (lineItem.label === 'Shipping') {
              updatedShippingItem = true;
              return Object.assign({}, lineItem, { amount: option.amount });
            }

            return lineItem;
          });

          if (!updatedShippingItem) {
            newLineItems.push({ label: 'Shipping', amount: option.amount, pending: false });
          }

          const amount = newLineItems
                  .reduce((total, lineItem) => {
                    total += parseFloat(lineItem.amount);
                    return total;
                  }, 0.0)
                  .toFixed(2);

          const newTotal = Object.assign({}, total, { amount });

          total = newTotal;
          lineItems = newLineItems;

          // Calling update is required.
          update({
            lineItems,
            total,
          });
        });

        // Checkpoint 1
        try {
          // Digital Wallets Buttons use the same element for both container and trigger
          const googlePayContainerAndTrigger = '#google-pay-container';
          const googlePay = await initializeGooglePay({
            payments,
            paymentRequest,
            containerElementOrSelector: googlePayContainerAndTrigger,
          });

          return createGooglePayPaymentOnClick(googlePay);
        } catch (e) {
          console.error('Initializing Google Pay failed', e);
        }
      }

      // Checkpoint 1
      initializePayments(appId, locationId)
        // Checkpoint 2
        .then((paymentResult) => {
          console.debug('Payment Success', paymentResult);
        });
    </script>
  </head>
  <body>
    <div class="payment-form">
      <div id="google-pay-container"></div>
    </div>
  </body>
</html>

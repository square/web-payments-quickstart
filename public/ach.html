<!DOCTYPE html>
<html>
  <head>
    <link href="app.css" rel="stylesheet" />
    <script
      type="text/javascript"
      src="https://sandbox.web.squarecdn.com/v0/square.js"
    ></script>
    <script type="module">
      // Checkpoint 2
      import createPayment from './services/create-payment.js';
      import { getBillingContact } from '../helpers/form.js';

      // Checkpoint 1
      const appId = 'sandbox-sq0idb-lybe_WkfKNAbb3WklswmwA';
      const locationId = 'LKYXSPGPXK05M';

      // Checkpoint 2
      async function createAchPayment(ach, { billingContact }) {
        const accountHolderName = [
          billingContact.givenName,
          billingContact.familyName,
        ].join(' ');

        const tokenResult = await ach.tokenize({ accountHolderName });

        if (tokenResult.status === 'OK') {
          const paymentResult = await createPayment({
            tokenResult,
          });

          if (paymentResult) {
            return paymentResult;
          }
        }

        return false;
      }

      // Checkpoint 2
      function createAchPaymentOnFormSubmit(ach) {
        const achForm = document.querySelector('#ach-form');
        const event = 'submit';
        return new Promise((resolve) => {
          achForm.addEventListener(event, async (e) => {
            e.preventDefault();
            e.stopPropagation();

            // disable form submission
            const submitButton = achForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            // Get other data bound to form submission
            const billingContact = getBillingContact(achForm);

            const paymentResult = await createAchPayment(ach, {
              billingContact,
            });

            if (paymentResult) {
              resolve(paymentResult);
            }

            // Re-enable the button if we don't succeed
            submitButton.disabled = false;
          });
        });
      }

      // Checkpoint 1
      async function initializePayments(appId, locationId) {
        try {
          const payments = window.Square.payments(appId, locationId);

          const ach = await payments.ach();

          // Note: ACH does not have an .attach(...) method
          // the ACH auth flow is triggered by .tokenize(...)

          return createAchPaymentOnFormSubmit(ach);
        } catch (e) {
          console.error('Initializing ACH failed', e);
        }
      }

      // Checkpoint 1
      initializePayments(appId, locationId)
        // Checkpoint 2
        .then((paymentResult) => {
          console.debug('Payment Success', paymentResult);
        });
    </script>
  </head>
  <body>
    <form id="ach-form" class="payment-form">
      <div class="buyer-inputs">
        <input
          type="text"
          aria-required="true"
          aria-label="First Name"
          required="required"
          placeholder="Given Name"
          name="givenName"
        />

        <input
          type="text"
          aria-required="true"
          aria-label="Last Name"
          required="required"
          placeholder="Family Name"
          name="familyName"
        />
      </div>

      <button id="ach-button" type="submit">Pay with Bank Account</button>
    </form>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <link href="app.css" rel="stylesheet" />
    <script
      type="text/javascript"
      src="https://sandbox.web.squarecdn.com/v0/square.js"
    ></script>
    <script type="module">
      const appId = 'sandbox-sq0idb-lybe_WkfKNAbb3WklswmwA';
      const locationId = 'LKYXSPGPXK05M';

      async function createPayment({ tokenResult }) {
        const body = JSON.stringify({
          tokenResult,
        });

        const createPaymentResponse = await fetch('/payment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body,
        })
          .then((response) => {
            return response.json();
          })
          .catch((e) => {
            console.error('Something went wrong processing the payment', e);
          });

        return createPaymentResponse;
      }

      function createCardPaymentOnFormSubmit(payments, card, paymentDetails) {}

      async function initializePayments(appId, locationId) {
        try {
          const payments = await window.Square.payments(appId, locationId);

          const card = await payments.card();

          const cardContainer = '#card-container';
          await card.attach(cardContainer);

          // TODO: create card payment
          const cardForm = document.querySelector('#card-form');
          const event = 'submit';
          return new Promise((resolve) => {
            cardForm.addEventListener(event, async (e) => {
              e.preventDefault();
              e.stopPropagation();

              const tokenResult = await card.tokenize();

              const paymentResult = await createPayment({ tokenResult });

              if (paymentResult) {
                // disable form submission on success
                const submitButton = cardForm.querySelector(
                  'button[type="submit"]'
                );
                submitButton.disabled = true;

                resolve(paymentResult);
              }
            });
          });
        } catch (e) {
          console.error('Initializing Card failed', e);
        }
      }

      initializePayments(appId, locationId);
    </script>
  </head>
  <body>
    <form id="card-form" class="payment-form">
      <div id="card-container"></div>

      <button type="submit">Pay $1.00</button>
    </form>
  </body>
</html>
